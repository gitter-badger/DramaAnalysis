---
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
  pdf_document:
    toc: true
    toc_depth: 2
params:
  id:
  - "turm:3"
  - "turm:1"
  - "turm:2"
  col: NULL
  dynamic: TRUE
  charAlignment: NULL
  topn: 10
  titles: NULL
---


```{r,echo=FALSE}
pver <- packageVersion("DramaAnalysis")
```


```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)

if (is.null(.Options$qd.datadir)) { 
  DramaAnalysis::setup()
}

getYPositions <- function(x,b,limit=100) {
  rl <- apply(x, 2, function(xx) {
    xx <- as.double(xx)
    cs <- c(0,head(cumsum(xx),-1))
    r <- cs + xx/2
    r[xx<=limit] <- NA
    r  
  })
  rl
}

toFigureName <- function(x) {
  tools::toTitleCase(tolower(x))
}
library(data.table)
library(DramaAnalysis)
library(magrittr)
library(highcharter)
library(stringdist)

#print(class(params$id))
#print(params$id[[2]])
text <- loadSegmentedText(params$id)
meta <- loadMeta(params$id)
characters <- loadCharacters(params$id)
if (is.null(params$titles)) {
  titles <- toFigureName(meta$documentTitle)
} else {
  titles <- params$titles
}
names(titles) <- params$id
```


```{r}
if (is.null(params$charAlignment)) {
  
}
```

---
title: "QuaDramA Edition Comparison"

---

This report shows a number of quantitative properties extracted from several plays. 
The report assumes the plays to be different variants *of the same text* (what ever
that means).

# Meta data

```{r, results="asis"}


knitr::kable(meta,
             col.names = c("Corpus", "Text-Id", "Title", "Language", "Author name", "Author Id", "Translator name", "Translator Id", "Year written", "Year printed", "Year premiered", "Year translated"),
             format = "markdown")

```


# Structure {.tabset}



## Overview

```{r}
tbl <- text[,.(Acts=length(unique(begin.Act)),
               Scenes=length(unique(begin.Scene))),
            .(corpus,drama)]
rownames(tbl) <- paste(tbl$corpus,tbl$drama,sep=":")
tblm <- as.matrix(tbl[,3:ncol(tbl)])

barplot(tblm,
        beside=TRUE,
        legend.text = titles[rownames(tbl)],
        col=params$col,args.legend = c(x="bottom"))

#knitr::kable(tbl)

```

## Differences

# Characters {.tabset}

## Number of Characters {.tabset}

```{r}
tbl <- text[,.(Characters=length(unique(Speaker.figure_surface))),
            .(corpus,drama)]
rownames(tbl) <- titles[paste(tbl$corpus,tbl$drama,sep=":")]
tblm <- as.matrix(tbl[,3:ncol(tbl)])
```

### Overview

```{r}
tbl <- text[,.(Characters=length(unique(Speaker.figure_surface))),
            .(corpus,drama)]
rownames(tbl) <- titles[paste(tbl$corpus,tbl$drama,sep=":")]
tblm <- as.matrix(tbl[,3:ncol(tbl)])
rownames(tblm) <- rownames(tbl)
barplot(tblm,
        beside=TRUE,
        legend.text = rownames(tbl),
        col=params$col, args.legend = c(x="bottom"))

#knitr::kable(tbl)

```

### Table

#### Absolute numbers

```{r, results="asis"}
knitr::kable(tblm, format="markdown", row.names = TRUE)
```

#### Differences
```{r}
knitr::kable(as.matrix(dist(tblm)))
```

## Spoken words {.tabset}

### Overview

This plot shows the spoken words of the most talkative `r params$topn` characters per play.

```{r}
tl <- limitFigures(text, threshold = params$topn)

fstat <- figureStatistics(tl, names=TRUE)

xt <- xtabs(tokens ~ paste(corpus,drama,sep=":")+figure,data=fstat)

attr(xt, "class") <- NULL 
attr(xt, "call") <- NULL 
#barplot(xt, beside=TRUE,las=3)

xt <- as.data.frame(t(xt))
colnames(xt) <- titles[colnames(xt)]
hc <- highchart()

hc <- hc_yAxis(hc, max=max(xt))
hc <- hc_xAxis(hc, categories=rownames(xt))

for (i in 1:ncol(xt)) {
  hc <- hc_add_series(hc, xt[,i], type="column", name=colnames(xt)[i])
}

hc

```

### Table

The table shows token numbers for all characters.

```{r, results="asis"}
fstat <- figureStatistics(text, names=TRUE)

xt <- xtabs(tokens ~ paste(corpus,drama,sep=":")+figure,data=fstat)
attr(xt, "class") <- NULL 
attr(xt, "call") <- NULL 
xt <- as.data.frame(t(xt))
colnames(xt) <- titles[colnames(xt)]


knitr::kable(xt, format="markdown")


```


## Utterances {.tabset}

### Lengths

This plot shows the distribution of utterange lengths for the top `r params$topn` characters in each play. If two characters are aligned, their box is shown side by side. More on [box plots in Wikipedia](https://en.wikipedia.org/wiki/Box_plot). Dots outside of the box indicate potential outliers, color shows the play they belong to.

```{r}
ustat <- utteranceStatistics(text, numberOfFigures = params$topn)

if (is.null(params$col)) {
  col = "black"
} else {
  col = params$col[1:length(params$id)]
}

hcboxplot(x=ustat$utteranceLength, 
          var=as.character(ustat$figure), 
          var2=as.character(ustat$drama),
          color=col
          )


```

### Table

This table records information about *every utterance* in each play. It is therefore very long.

```{r, results="asis"}

knitr::kable(ustat, format="markdown")

```


```{r, eval=FALSE}



utteranceDistances <- function(t) {
  tagg <- t[,.(text=paste0(Token.surface, collapse=" ")),.(corpus,drama,begin, Speaker.figure_surface)]
  pairs <- t(combn(nrow(tagg),2))
  for(i in 1:nrow(pairs)) {
    row_a <- pairs[i,1]
    row_b <- pairs[i,2]
    
  }
  
}

text[,
     mcp:=max(end),
     .(corpus,drama)][,
                      .(utteranceLength=.N,rbegin=begin/mcp),
                      .(corpus,drama,begin,Speaker.figure_surface)][]

```

# Presence and Utterances {.tabset}

```{r}

textl <- limitFigures(text, threshold = params$topn, other = "_other")

ustat <- utteranceStatistics(textl, normalizeByDramaLength = FALSE, numberOfFigures = FALSE)
ustat$figure <- tools::toTitleCase(tolower(ustat$figure))
```

## All Utterances
```{r}
par(mar=c(1,9,1,0),xpd=FALSE)

for (id in params$id) {
  splid <- strsplit(id,":",fixed=TRUE)[[1]]
  plotUtterancePositions(ustat[paste(ustat$corpus,ustat$drama,sep=":") == id,],
                         segmentedText=text[paste(text$corpus,text$drama,sep=":") == id,],
                         xlab="", main=toFigureName(meta[meta$corpus==splid[1] & meta$drama==splid[2],3]))
}
```


# Configuration and Copresence {.tabset}

```{r, fig.height=10}
configs <- lapply(params$id, function(x) {
  splid <- strsplit(x,":",fixed=TRUE)[[1]]
  
  cfg <- configuration(text[text$corpus==splid[1] & text$drama==splid[2],], 
                       onlyPresence=TRUE,
                       by="Scene")
  copr <- cfg$matrix %*% t(cfg$matrix)
  rownames(copr) <- as.character(cfg$figure)
  colnames(copr) <- as.character(cfg$figure)
  copr <- reshape::melt.array(copr)
  copr <- copr[copr$X1 != copr$X2,]
  copr$gid <- x
  copr
})
names(configs) <- params$id

allcopresence <- Reduce(rbind, configs)
allcopresence$X1 <- as.character(allcopresence$X1)
allcopresence$X2 <- as.character(allcopresence$X2)

ac <- cast(allcopresence, formula =  X1+X2~gid)

ac <- ac[!is.na(rowSums(ac[3:5])) & rowSums(ac[3:5])>1,]
ac <- ac[ac[3] != ac[4] | ac[4] != ac[5],]
ac$pname <- paste(ac$X1, ac$X2, sep=" & ")
ac$X1 <- NULL
ac$X2 <- NULL

hc <- highchart(height=500)
hc <- hc_yAxis(hc, max=max(ac[1:3]))
hc <- hc_xAxis(hc, categories=colnames(ac[1:3]))
for (i in 1:nrow(ac)) {
  hc <- hc_add_series(hc, data=as.numeric(ac[i,1:3]), type="line", name=ac$pname[i], visible=FALSE)
}
hc

```